<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ÏõîÍ∞Ñ Í≥ÑÌöç Ï∫òÎ¶∞Îçî - Î™®Î∞îÏùº</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  body { font-family: 'Malgun Gothic', 'ÎßëÏùÄ Í≥†Îîï', sans-serif; background: #f0f4f8; min-height: 100vh; }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  .header { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: #fff; box-shadow: 0 1px 6px rgba(0,0,0,.1); position: sticky; top: 0; z-index: 100; }
  .header-nav { display: flex; align-items: center; gap: 6px; }
  .header-title { font-size: 18px; font-weight: 700; color: #1a2a4a; }
  .btn-icon { border: none; background: none; font-size: 18px; padding: 8px 10px; color: #555; cursor: pointer; }
  .btn-today { border: none; background: #4f86f7; color: #fff; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-family: inherit; cursor: pointer; }
  .header-right { display: flex; align-items: center; gap: 8px; }
  #syncStatus { font-size: 11px; padding: 3px 8px; border-radius: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
  #syncStatus.connected    { background: #e8f8ee; color: #27ae60; }
  #syncStatus.disconnected { background: #fdecea; color: #e74c3c; }
  #syncStatus.syncing      { background: #fff3e0; color: #f5a623; }
  .dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

  /* ‚îÄ‚îÄ Tab Bar ‚îÄ‚îÄ */
  .tab-bar { display: flex; background: #fff; border-bottom: 1px solid #e0e6ef; position: sticky; top: 53px; z-index: 99; }
  .tab-btn { flex: 1; padding: 11px 0; font-size: 14px; font-weight: 600; color: #aaa; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent; font-family: inherit; transition: all .2s; }
  .tab-btn.active { color: #4f86f7; border-bottom-color: #4f86f7; }

  /* ‚îÄ‚îÄ Tab Content ‚îÄ‚îÄ */
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* ‚îÄ‚îÄ Monthly Calendar ‚îÄ‚îÄ */
  .calendar { background: #fff; margin: 10px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.08); overflow: hidden; }
  .day-headers { display: grid; grid-template-columns: repeat(7, 1fr); }
  .day-header { padding: 8px 0; text-align: center; font-weight: 700; font-size: 12px; border-bottom: 2px solid #e0e6ef; }
  .day-header.sun  { background: #fff1f1; color: #e74c3c; }
  .day-header.sat  { background: #f0f4ff; color: #4f86f7; }
  .day-header.week { background: #f8f9fa; color: #555; }
  .week-row { display: grid; grid-template-columns: repeat(7, 1fr); border-bottom: 1px solid #e0e6ef; }
  .week-row:last-child { border-bottom: none; }
  .cell { min-height: 60px; padding: 3px 2px; border-left: 1px solid #e0e6ef; overflow: hidden; min-width: 0; }
  .cell:first-child { border-left: none; }
  .cell.empty { background: #fafafa; }
  .cell.today { background: #fffbe6; }
  .cell-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
  .date-num { display: inline-flex; align-items: center; justify-content: center; width: 22px; height: 22px; border-radius: 50%; font-size: 11px; font-weight: 600; color: #333; }
  .date-num.today-num { background: #4f86f7; color: #fff; }
  .date-num.sun-num { color: #e74c3c; }
  .date-num.sat-num { color: #4f86f7; }
  .add-btn { border: none; background: none; font-size: 14px; color: #ccc; padding: 2px 3px; cursor: pointer; line-height: 1; }
  .items { display: flex; flex-direction: column; gap: 1px; min-width: 0; width: 100%; }
  .item { border-radius: 3px; padding: 1px 14px 1px 4px; font-size: 9px; color: #fff; position: relative; cursor: pointer; line-height: 1.4; overflow: hidden; min-width: 0; max-width: 100%; }
  .item .txt { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
  .item .del { position: absolute; top: 1px; right: 2px; font-size: 9px; opacity: .8; background: rgba(0,0,0,0.2); border-radius: 2px; padding: 0 1px; }
  .item-more { font-size: 9px; color: #888; padding: 1px 4px; cursor: pointer; text-align: right; line-height: 1.4; }
  .item-more:active { color: #4f86f7; }

  /* ‚îÄ‚îÄ Monthly action bar ‚îÄ‚îÄ */
  .month-action-bar { display: flex; justify-content: flex-end; gap: 8px; padding: 0 10px 10px; }
  .btn-csv { border: none; background: #52c97a; color: #fff; padding: 8px 16px; border-radius: 8px; font-size: 13px; font-family: inherit; cursor: pointer; }
  .btn-settings { border: 1px solid #ddd; background: #fff; padding: 8px 12px; border-radius: 8px; font-size: 13px; font-family: inherit; cursor: pointer; color: #aaa; }

  /* ‚îÄ‚îÄ Weekly View ‚îÄ‚îÄ */
  .weekly-header-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 12px 8px; }
  .weekly-header-row h3 { font-size: 16px; font-weight: 700; color: #1a2a4a; }
  .weekly-nav { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; justify-content: flex-end; }
  .week-label { font-size: 12px; color: #555; font-weight: 600; text-align: right; }
  .btn-sm { border: 1px solid #ddd; background: #fff; padding: 5px 10px; border-radius: 6px; font-size: 13px; cursor: pointer; font-family: inherit; }
  .weekly-scroll { display: flex; gap: 8px; padding: 0 10px 16px; overflow-x: auto; -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory; }
  .weekly-scroll::-webkit-scrollbar { display: none; }
  .wday-col { flex: 0 0 140px; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,.08); overflow: hidden; min-height: 180px; display: flex; flex-direction: column; scroll-snap-align: start; }
  .wday-col.w-today { box-shadow: 0 0 0 2px #4f86f7, 0 2px 8px rgba(0,0,0,.08); }
  .wday-col-header { padding: 8px 6px; text-align: center; border-bottom: 2px solid #e0e6ef; }
  .wday-name { font-size: 12px; font-weight: 700; }
  .wday-name.sun { color: #e74c3c; }
  .wday-name.sat { color: #4f86f7; }
  .wday-date { font-size: 20px; font-weight: 800; margin-top: 2px; color: #1a2a4a; }
  .wday-date.today-big { background: #4f86f7; color: #fff; border-radius: 50%; width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; font-size: 18px; margin-top: 4px; }
  .wday-date.sun { color: #e74c3c; }
  .wday-date.sat { color: #4f86f7; }
  .wday-items { flex: 1; padding: 6px; display: flex; flex-direction: column; gap: 3px; }
  .wday-item { border-radius: 5px; padding: 4px 20px 4px 7px; font-size: 11px; color: #fff; cursor: pointer; line-height: 1.4; position: relative; word-break: break-word; }
  .wday-item span { display: block; }
  .wday-item .del { position: absolute; top: 4px; right: 4px; font-size: 10px; opacity: .8; background: rgba(0,0,0,0.2); border-radius: 3px; padding: 0 2px; }
  .wday-add { margin: 0 6px 8px; border: 1.5px dashed #ccc; background: none; color: #aaa; border-radius: 6px; padding: 7px 0; font-size: 12px; width: calc(100% - 12px); cursor: pointer; font-family: inherit; }

  /* ‚îÄ‚îÄ Overlay ‚îÄ‚îÄ */
  .overlay { display: none; position: fixed; inset: 0; z-index: 999; }
  .overlay.show { display: block; background: rgba(0,0,0,0.4); }

  /* ‚îÄ‚îÄ Bottom Sheet Modal ‚îÄ‚îÄ */
  .modal { position: fixed; bottom: -400px; left: 0; right: 0; background: #fff; border-radius: 18px 18px 0 0; box-shadow: 0 -4px 24px rgba(0,0,0,.18); padding: 0 16px 24px; z-index: 1000; transition: bottom .3s cubic-bezier(.4,0,.2,1); }
  .modal.show { bottom: 0; }
  .modal-handle { width: 36px; height: 4px; background: #ddd; border-radius: 2px; margin: 10px auto 14px; }
  .modal-title { font-size: 13px; color: #888; margin-bottom: 8px; }
  .modal input[type=text] { width: 100%; padding: 11px 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 15px; font-family: inherit; margin-bottom: 10px; outline: none; }
  .modal input[type=text]:focus { border-color: #4f86f7; }
  .color-row { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; }
  .color-dot { width: 26px; height: 26px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform .15s; }
  .color-dot.selected { border: 3px solid #333; transform: scale(1.15); }
  .modal-btns { display: flex; gap: 8px; }
  .btn-save   { flex: 1; background: #4f86f7; color: #fff; border: none; padding: 13px 0; font-family: inherit; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; }
  .btn-cancel { flex: 1; background: #eee; border: none; padding: 13px 0; font-family: inherit; border-radius: 8px; font-size: 15px; cursor: pointer; }

  /* ‚îÄ‚îÄ Detail Bottom Sheet ‚îÄ‚îÄ */
  .detail-panel { position: fixed; bottom: -100vh; left: 0; right: 0; height: 76vh; background: #fff; border-radius: 18px 18px 0 0; box-shadow: 0 -4px 24px rgba(0,0,0,.15); z-index: 1000; transition: bottom .3s cubic-bezier(.4,0,.2,1); display: flex; flex-direction: column; overflow: hidden; }
  .detail-panel.open { bottom: 0; }
  .detail-drag-handle { padding: 10px 0 4px; display: flex; justify-content: center; flex-shrink: 0; cursor: grab; touch-action: none; }
  .detail-drag-handle-bar { width: 36px; height: 4px; background: #ddd; border-radius: 2px; }
  .detail-color-bar { height: 6px; flex-shrink: 0; transition: background .4s; }
  .detail-panel-header { padding: 10px 16px 10px; border-bottom: 1px solid #e0e6ef; flex-shrink: 0; }
  .detail-panel-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; margin-bottom: 6px; }
  .detail-panel-title { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 14px; font-weight: 700; color: #fff; word-break: break-word; line-height: 1.5; max-width: calc(100% - 120px); transition: background .4s; }
  .detail-panel-date { font-size: 12px; color: #888; margin-top: 2px; }
  .detail-panel-btns { display: flex; gap: 6px; flex-shrink: 0; }
  .detail-panel-btn { border: none; cursor: pointer; padding: 6px 10px; border-radius: 6px; font-size: 12px; font-family: inherit; }
  .detail-panel-btn.edit  { background: #f0f4ff; color: #4f86f7; }
  .detail-panel-btn.close { background: #f0f0f0; color: #555; }
  .detail-progress-wrap { padding: 10px 16px 0; flex-shrink: 0; }
  .detail-progress-label { font-size: 12px; color: #666; margin-bottom: 6px; font-weight: 600; }
  .detail-progress-track { height: 7px; background: #e0e6ef; border-radius: 4px; overflow: hidden; }
  .detail-progress-fill { height: 100%; background: #52c97a; border-radius: 4px; transition: width .3s; }
  .detail-sub-list { flex: 1; overflow-y: auto; padding: 10px 16px; display: flex; flex-direction: column; gap: 8px; -webkit-overflow-scrolling: touch; }
  .sub-item { display: flex; align-items: flex-start; gap: 10px; padding: 10px 12px; border-radius: 8px; background: #f8f9fa; border: 1px solid #e8ecf0; }
  .sub-item input[type=checkbox] { cursor: pointer; width: 20px; height: 20px; flex-shrink: 0; accent-color: #4f86f7; margin-top: 2px; }
  .sub-text { flex: 1; font-size: 14px; color: #333; word-break: break-word; line-height: 1.5; }
  .sub-text.done { text-decoration: line-through; color: #bbb; }
  .sub-del-btn  { border: none; background: none; cursor: pointer; font-size: 16px; color: #ddd; padding: 0 4px; flex-shrink: 0; }
  .sub-edit-btn { border: none; background: none; cursor: pointer; font-size: 14px; color: #ccc; padding: 0 4px; flex-shrink: 0; }
  .sub-edit-input { flex: 1; padding: 5px 8px; border: 1.5px solid #4f86f7; border-radius: 5px; font-size: 14px; font-family: inherit; outline: none; min-width: 0; }
  .detail-empty { text-align: center; padding: 40px 0; color: #bbb; font-size: 14px; }
  .detail-add-row { padding: 10px 16px; border-top: 1px solid #e0e6ef; display: flex; gap: 8px; flex-shrink: 0; }
  .detail-add-row input { flex: 1; padding: 11px 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; font-family: inherit; outline: none; }
  .detail-add-row input:focus { border-color: #4f86f7; }
  .detail-add-btn { border: none; background: #4f86f7; color: #fff; border-radius: 8px; padding: 11px 16px; font-size: 14px; cursor: pointer; font-family: inherit; font-weight: 600; }

  /* ‚îÄ‚îÄ Config Panel ‚îÄ‚îÄ */
  #configPanel { background: #fff3cd; border: 1px solid #ffc107; border-radius: 10px; padding: 16px; margin: 12px; }
  #configPanel h4 { color: #856404; margin-bottom: 8px; font-size: 14px; }
  #configPanel textarea { width: 100%; height: 140px; border-radius: 6px; border: 1px solid #ddd; padding: 8px; font-size: 12px; font-family: monospace; resize: vertical; }
  #btnApplyConfig { margin-top: 8px; background: #f5a623; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; font-family: inherit; cursor: pointer; font-size: 14px; }
  #configPanel p { font-size: 12px; color: #856404; margin-bottom: 6px; }
  #debugLog { margin-top: 10px; background: #1e1e1e; color: #0f0; border-radius: 6px; padding: 10px; font-size: 11px; font-family: monospace; max-height: 150px; overflow-y: auto; display: none; white-space: pre-wrap; word-break: break-all; }
</style>
</head>
<body>

<div id="configPanel">
  <h4>üîß Firebase ÏÑ§Ï†ï ÏûÖÎ†• (ÏµúÏ¥à 1ÌöåÎßå)</h4>
  <p>Firebase ÏΩòÏÜîÏóêÏÑú Î≥µÏÇ¨Ìïú <strong>firebaseConfig</strong> Ï†ÑÏ≤¥Î•º Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî.</p>
  <textarea id="configInput" placeholder="const firebaseConfig = { ... } Ï†ÑÏ≤¥ Î∂ôÏó¨ÎÑ£Í∏∞"></textarea>
  <br>
  <button id="btnApplyConfig">‚úÖ Ï†ÄÏû• Î∞è Ïó∞Í≤∞</button>
  <div id="debugLog"></div>
</div>

<div id="mainUI" style="display:none">
  <!-- Header -->
  <div class="header">
    <div class="header-nav">
      <button class="btn-icon" id="btnPrev">‚óÄ</button>
      <h2 class="header-title" id="title"></h2>
      <button class="btn-icon" id="btnNext">‚ñ∂</button>
      <button class="btn-today" id="btnToday">Ïò§Îäò</button>
    </div>
    <div class="header-right">
      <span id="syncStatus" class="syncing"><span class="dot"></span> Ïó∞Í≤∞ Ï§ë...</span>
    </div>
  </div>

  <!-- Tab Bar -->
  <div class="tab-bar">
    <button class="tab-btn active" id="tabMonth" onclick="switchTab('month')">üìÖ ÏõîÍ∞Ñ</button>
    <button class="tab-btn" id="tabWeek" onclick="switchTab('week')">üìã Ï£ºÍ∞Ñ</button>
  </div>

  <!-- Monthly Tab -->
  <div class="tab-content active" id="contentMonth">
    <div class="calendar">
      <div class="day-headers">
        <div class="day-header sun">Ïùº</div>
        <div class="day-header week">Ïõî</div>
        <div class="day-header week">Ìôî</div>
        <div class="day-header week">Ïàò</div>
        <div class="day-header week">Î™©</div>
        <div class="day-header week">Í∏à</div>
        <div class="day-header sat">ÌÜ†</div>
      </div>
      <div id="calBody"></div>
    </div>
    <div class="month-action-bar">
      <button class="btn-settings" id="btnResetConfig">‚öôÔ∏è ÏÑ§Ï†ï</button>
      <button class="btn-csv" id="btnCsv">üì• CSV</button>
    </div>
  </div>

  <!-- Weekly Tab -->
  <div class="tab-content" id="contentWeek">
    <div class="weekly-header-row">
      <h3>üìã Ï£ºÍ∞Ñ Í≥ÑÌöç</h3>
      <div class="weekly-nav">
        <button class="btn-sm" id="btnWPrev">‚óÄ</button>
        <span class="week-label" id="weekLabel"></span>
        <button class="btn-sm" id="btnWNext">‚ñ∂</button>
        <button class="btn-today" id="btnWToday">Ïù¥Î≤à Ï£º</button>
      </div>
    </div>
    <div class="weekly-scroll" id="weeklyGrid"></div>
  </div>
</div>

<div class="overlay" id="overlay"></div>

<!-- Bottom Sheet Modal -->
<div class="modal" id="modal">
  <div class="modal-handle"></div>
  <div class="modal-title" id="modalTitle"></div>
  <input type="text" id="modalInput" placeholder="ÏùºÏ†ï ÎÇ¥Ïö© ÏûÖÎ†•..." maxlength="50">
  <div class="color-row" id="colorRow"></div>
  <div class="modal-btns">
    <button class="btn-save" id="btnSave">Ï∂îÍ∞Ä</button>
    <button class="btn-cancel" id="btnCancel">Ï∑®ÏÜå</button>
  </div>
</div>

<!-- Detail Bottom Sheet -->
<div class="detail-panel" id="detailPanel">
  <div class="detail-drag-handle" id="detailDragHandle">
    <div class="detail-drag-handle-bar"></div>
  </div>
  <div class="detail-color-bar" id="detailColorBar"></div>
  <div class="detail-panel-header">
    <div class="detail-panel-top">
      <div class="detail-panel-title" id="detailPanelTitle"></div>
      <div class="detail-panel-btns">
        <button class="detail-panel-btn edit" id="btnDetailEdit">‚úèÔ∏è ÏàòÏ†ï</button>
        <button class="detail-panel-btn close" id="btnDetailClose">‚úï</button>
      </div>
    </div>
    <div class="detail-panel-date" id="detailPanelDate"></div>
  </div>
  <div class="detail-progress-wrap" id="detailProgressWrap">
    <div class="detail-progress-label" id="detailProgressLabel"></div>
    <div class="detail-progress-track"><div class="detail-progress-fill" id="detailProgressFill"></div></div>
  </div>
  <div class="detail-sub-list" id="detailSubList"></div>
  <div class="detail-add-row">
    <input type="text" id="detailInput" placeholder="ÏÑ∏Î∂ÄÏùºÏ†ï Ï∂îÍ∞Ä..." maxlength="50">
    <button class="detail-add-btn" id="btnDetailAdd">Ï∂îÍ∞Ä</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
<script>
const COLORS  = ["#0a0101","#9b59b6","#4f86f7","#f76b6b","#52c97a","#f5a623","#1abc9c","#e74c3c"];
const DAYS_KR = ["Ïùº","Ïõî","Ìôî","Ïàò","Î™©","Í∏à","ÌÜ†"];
const today   = new Date();
let year, month, plans = {}, weekBase = new Date(today);
let modal = { dateKey:null, editIdx:null, colorIdx:0 };
let dbRef = null;

// ‚îÄ‚îÄ ÌÉ≠ Ï†ÑÌôò ‚îÄ‚îÄ
function switchTab(tab) {
  document.getElementById('tabMonth').classList.toggle('active', tab === 'month');
  document.getElementById('tabWeek').classList.toggle('active', tab === 'week');
  document.getElementById('contentMonth').classList.toggle('active', tab === 'month');
  document.getElementById('contentWeek').classList.toggle('active', tab === 'week');
  if (tab === 'month') {
    renderMonth();
  } else {
    renderWeek();
    // Ïò§Îäò Ïª¨ÎüºÏúºÎ°ú Ïä§ÌÅ¨Î°§
    setTimeout(() => {
      const todayCol = document.querySelector('.wday-col.w-today');
      if (todayCol) todayCol.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
    }, 50);
  }
}

// ‚îÄ‚îÄ ÎîîÎ≤ÑÍ∑∏ Î°úÍ∑∏ ‚îÄ‚îÄ
const dbgEl = document.getElementById('debugLog');
function dbg(label, val) {
  const msg = `${label}: ${typeof val === 'string' ? val : JSON.stringify(val, null, 2)}`;
  console.log(msg);
  dbgEl.style.display = 'block';
  dbgEl.textContent += msg + '\n';
}
function dbgErr(label, e) {
  const msg = `‚ùå ${label}: ${e.message}`;
  console.error(msg, e);
  dbgEl.style.display = 'block';
  dbgEl.textContent += msg + '\n';
}

// ‚îÄ‚îÄ Firebase Ï¥àÍ∏∞Ìôî ‚îÄ‚îÄ
function initFirebase(config) {
  try {
    dbg('[initFirebase] config', config);
    if (!firebase.apps.length) {
      firebase.initializeApp(config);
    }
    dbg('[initFirebase] Ïï± Ï¥àÍ∏∞Ìôî ÏôÑÎ£å', firebase.app().name);
    const db = firebase.database();
    dbRef = db.ref('calendar/plans');
    dbg('[initFirebase] dbRef ÏÉùÏÑ± ÏôÑÎ£å', 'calendar/plans');

    db.ref('.info/connected').on('value', snap => {
      const el = document.getElementById('syncStatus');
      if (snap.val()) {
        el.className = 'connected'; el.innerHTML = '<span class="dot"></span> Ïó∞Í≤∞Îê®';
        dbg('[Ïó∞Í≤∞ÏÉÅÌÉú]', 'Ïó∞Í≤∞Îê®');
      } else {
        el.className = 'disconnected'; el.innerHTML = '<span class="dot"></span> ÎÅäÍπÄ';
        dbg('[Ïó∞Í≤∞ÏÉÅÌÉú]', 'ÎÅäÍπÄ');
      }
    });

    dbRef.on('value', snap => {
      plans = snap.val() || {};
      dbg('[Îç∞Ïù¥ÌÑ∞ ÏàòÏã†]', `${Object.keys(plans).length}Í∞ú ÎÇ†Ïßú`);
      renderAll();
    });

    document.getElementById('configPanel').style.display = 'none';
    document.getElementById('mainUI').style.display = 'block';
  } catch(e) {
    dbgErr('[initFirebase Ïò§Î•ò]', e);
    alert('Firebase Ï¥àÍ∏∞Ìôî Ïò§Î•ò: ' + e.message);
  }
}

// ‚îÄ‚îÄ ÏÑ§Ï†ïÍ∞í ÌååÏã± ‚îÄ‚îÄ
document.getElementById('btnApplyConfig').onclick = () => {
  dbgEl.textContent = '';
  dbgEl.style.display = 'block';
  const raw = document.getElementById('configInput').value;
  dbg('[1] raw Í∏∏Ïù¥', raw.length);

  const match = raw.match(/\{[\s\S]*\}/);
  if (!match) { alert('{ } Î∏îÎ°ùÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.'); return; }
  dbg('[2] { } Ï∂îÏ∂ú ÏÑ±Í≥µ, Í∏∏Ïù¥', match[0].length);

  try {
    let s = match[0];
    s = s.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '');
    s = s.replace(/\u200B|\u200C|\u200D|\uFEFF/g, '');
    s = s.replace(/^\s*\/\/.*$/gm, '').replace(/\/\*[\s\S]*?\*\//g, '');
    s = s.replace(/,(\s*[\}\]])/g, '$1');
    s = s.replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":');
    dbg('[7] ÌÇ§ Îî∞Ïò¥Ìëú Ï∂îÍ∞Ä ÌõÑ', s);

    const cfg = JSON.parse(s);
    dbg('[8] ÌååÏã± ÏÑ±Í≥µ!', Object.keys(cfg));
    if (!cfg.databaseURL) { alert('databaseURLÏù¥ ÏóÜÏäµÎãàÎã§!'); return; }
    localStorage.setItem('fbConfig', JSON.stringify(cfg));
    initFirebase(cfg);
  } catch(e) {
    dbgErr('[ÌååÏã± Ïò§Î•ò]', e);
    alert('ÌååÏã± Ïò§Î•ò: ' + e.message);
  }
};

document.getElementById('btnResetConfig').onclick = () => {
  document.getElementById('configPanel').style.display = 'block';
  document.getElementById('mainUI').style.display = 'none';
};

// Ï†ÄÏû•Îêú ÏÑ§Ï†ï ÏûêÎèô Î°úÎìú
const saved = localStorage.getItem('fbConfig');
if (saved) {
  try { initFirebase(JSON.parse(saved)); } catch(e) { console.error(e); }
}

// ‚îÄ‚îÄ DB Ï†ÄÏû• ‚îÄ‚îÄ
function save() {
  if (!dbRef) return;
  const st = document.getElementById('syncStatus');
  st.className='syncing'; st.innerHTML='<span class="dot"></span> Ï†ÄÏû• Ï§ë...';
  dbRef.set(plans)
    .then(()=>{ st.className='connected'; st.innerHTML='<span class="dot"></span> Ïó∞Í≤∞Îê®'; })
    .catch(e=>{ st.className='disconnected'; st.innerHTML='<span class="dot"></span> Ï†ÄÏû• Ïã§Ìå®'; alert('Ï†ÄÏû• Ïã§Ìå®: '+e.message); });
}

function dateKey(y,m,d){ return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
function isToday(d,m2,y2){ return y2===today.getFullYear()&&m2===today.getMonth()&&d===today.getDate(); }

/* ‚îÄ‚îÄ ÏÉâÏÉÅ Ïú†Ìã∏Î¶¨Ìã∞ ‚îÄ‚îÄ */
function hexToRgb(hex){ return [1,3,5].map(i=>parseInt(hex.slice(i,i+2),16)); }
function rgbToHex(r,g,b){ return '#'+[r,g,b].map(v=>Math.round(v).toString(16).padStart(2,'0')).join(''); }
function blendColor(hex1,hex2,t){
  const [r1,g1,b1]=hexToRgb(hex1), [r2,g2,b2]=hexToRgb(hex2);
  return rgbToHex(r1+(r2-r1)*t, g1+(g2-g1)*t, b1+(b2-b1)*t);
}
function getItemDisplayColor(it){
  const subs=it.sub||[]; if(!subs.length) return it.color;
  const ratio=subs.filter(s=>s.done).length/subs.length;
  return ratio===0?it.color:blendColor(it.color,'#9b59b6',ratio);
}

function renderMonth() {
  document.getElementById('title').textContent=`${year}ÎÖÑ ${month+1}Ïõî`;
  const body=document.getElementById('calBody'); body.innerHTML='';
  const firstDay=new Date(year,month,1).getDay(), dim=new Date(year,month+1,0).getDate();
  const cells=[];
  for(let i=0;i<firstDay;i++) cells.push(null);
  for(let d=1;d<=dim;d++) cells.push(d);
  while(cells.length%7!==0) cells.push(null);
  for(let w=0;w<cells.length/7;w++){
    const row=document.createElement('div'); row.className='week-row';
    for(let di=0;di<7;di++){
      const d=cells[w*7+di];
      const cell=document.createElement('div');
      cell.className='cell'+(!d?' empty':isToday(d,month,year)?' today':'');
      if(d){
        const key=dateKey(year,month,d);
        const hdr=document.createElement('div'); hdr.className='cell-header';
        const num=document.createElement('span');
        num.className='date-num'+(isToday(d,month,year)?' today-num':di===0?' sun-num':di===6?' sat-num':'');
        num.textContent=d;
        const ab=document.createElement('button'); ab.className='add-btn'; ab.textContent='+';
        ab.onclick=e=>{e.stopPropagation();openModal(key,null);};
        hdr.appendChild(num); hdr.appendChild(ab); cell.appendChild(hdr);
        const idiv=document.createElement('div'); idiv.className='items';
        const allItems=plans[key]||[];
        const MAX_VISIBLE=2;
        allItems.slice(0,MAX_VISIBLE).forEach((it,idx)=>{
          const item=document.createElement('div'); item.className='item'; item.style.background=getItemDisplayColor(it);
          const txt=document.createElement('span'); txt.className='txt'; txt.textContent=it.text;
          const del=document.createElement('span'); del.className='del'; del.textContent='‚úï';
          del.onclick=e=>{e.stopPropagation();deleteItem(key,idx);};
          item.onclick=e=>{e.stopPropagation();openDetail(key,idx);};
          item.appendChild(txt); item.appendChild(del); idiv.appendChild(item);
        });
        const hidden=allItems.length-MAX_VISIBLE;
        if(hidden>0){
          const more=document.createElement('div'); more.className='item-more';
          more.textContent=`... +${hidden}`;
          more.onclick=e=>{e.stopPropagation();openModal(key,null);};
          idiv.appendChild(more);
        }
        cell.appendChild(idiv);
      }
      row.appendChild(cell);
    }
    body.appendChild(row);
  }
}

function getWeekStart(base){ const d=new Date(base); d.setDate(d.getDate()-d.getDay()); return d; }
function renderWeek(){
  const ws=getWeekStart(weekBase), we=new Date(ws); we.setDate(we.getDate()+6);
  const fmt=d=>`${d.getMonth()+1}/${d.getDate()}`;
  document.getElementById('weekLabel').textContent=`${ws.getFullYear()}ÎÖÑ ${fmt(ws)}~${fmt(we)}`;
  const grid=document.getElementById('weeklyGrid'); grid.innerHTML='';
  for(let di=0;di<7;di++){
    const cur=new Date(ws); cur.setDate(ws.getDate()+di);
    const y2=cur.getFullYear(),m2=cur.getMonth(),d2=cur.getDate();
    const key=dateKey(y2,m2,d2); const isTd=isToday(d2,m2,y2);
    const col=document.createElement('div'); col.className='wday-col'+(isTd?' w-today':'');
    const hdr=document.createElement('div'); hdr.className='wday-col-header';
    const nm=document.createElement('div'); nm.className='wday-name'+(di===0?' sun':di===6?' sat':''); nm.textContent=DAYS_KR[di];
    const dt=document.createElement('div');
    dt.className=isTd?'wday-date today-big':'wday-date'+(di===0?' sun':di===6?' sat':'');
    dt.textContent=d2;
    hdr.appendChild(nm); hdr.appendChild(dt); col.appendChild(hdr);
    const idiv=document.createElement('div'); idiv.className='wday-items';
    (plans[key]||[]).forEach((it,idx)=>{
      const item=document.createElement('div'); item.className='wday-item'; item.style.background=getItemDisplayColor(it);
      const txt=document.createElement('span'); txt.textContent=it.text;
      const del=document.createElement('span'); del.className='del'; del.textContent='‚úï';
      del.onclick=e=>{e.stopPropagation();deleteItem(key,idx);};
      item.onclick=e=>{e.stopPropagation();openDetail(key,idx);};
      item.appendChild(txt); item.appendChild(del); idiv.appendChild(item);
    });
    col.appendChild(idiv);
    const ab=document.createElement('button'); ab.className='wday-add'; ab.textContent='+ ÏùºÏ†ï Ï∂îÍ∞Ä';
    ab.onclick=e=>{e.stopPropagation();openModal(key,null);};
    col.appendChild(ab); grid.appendChild(col);
  }
}
function renderAll(){ renderMonth(); if(document.getElementById('contentWeek').classList.contains('active')) renderWeek(); }

// ‚îÄ‚îÄ Bottom Sheet Modal (anchor ÏóÜÏùå - Ìï≠ÏÉÅ ÌïòÎã® ÏãúÌä∏) ‚îÄ‚îÄ
function openModal(key, editIdx){
  modal.dateKey=key; modal.editIdx=editIdx; modal.colorIdx=0;
  const inp=document.getElementById('modalInput');
  if(editIdx!==null && editIdx!==undefined){
    const it=plans[key][editIdx]; inp.value=it.text;
    modal.colorIdx=COLORS.indexOf(it.color)>=0?COLORS.indexOf(it.color):0;
    document.getElementById('modalTitle').textContent=`‚úèÔ∏è ÏàòÏ†ï ‚Äî ${key}`;
    document.getElementById('btnSave').textContent='ÏàòÏ†ï';
  } else {
    inp.value='';
    document.getElementById('modalTitle').textContent=`üìù Ï∂îÍ∞Ä ‚Äî ${key}`;
    document.getElementById('btnSave').textContent='Ï∂îÍ∞Ä';
  }
  renderColorRow();
  document.getElementById('modal').classList.add('show');
  document.getElementById('overlay').classList.add('show');
  setTimeout(()=>inp.focus(),300);
}
function renderColorRow(){
  const row=document.getElementById('colorRow'); row.innerHTML='';
  COLORS.forEach((c,i)=>{
    const dot=document.createElement('div');
    dot.className='color-dot'+(i===modal.colorIdx?' selected':'');
    dot.style.background=c;
    dot.onclick=()=>{modal.colorIdx=i;renderColorRow();};
    row.appendChild(dot);
  });
}
function closeModal(){
  document.getElementById('modal').classList.remove('show');
  if(!document.getElementById('detailPanel').classList.contains('open'))
    document.getElementById('overlay').classList.remove('show');
}
function saveItem(){
  const txt=document.getElementById('modalInput').value.trim(); if(!txt)return;
  const key=modal.dateKey;
  if(!plans[key]) plans[key]=[];
  if(modal.editIdx!==null && modal.editIdx!==undefined){
    const existingSub=plans[key][modal.editIdx].sub||[];
    plans[key][modal.editIdx]={text:txt,color:COLORS[modal.colorIdx],sub:existingSub};
  } else {
    plans[key].push({text:txt,color:COLORS[modal.colorIdx],sub:[]});
  }
  save(); closeModal(); renderAll();
}

/* ‚îÄ‚îÄ ÏÑ∏Î∂ÄÏùºÏ†ï ÌïòÎã® ÏãúÌä∏ ‚îÄ‚îÄ */
let detailState={dateKey:null,itemIdx:null};
function openDetail(key,idx){
  detailState={dateKey:key,itemIdx:idx};
  renderDetailPanel();
  document.getElementById('detailPanel').classList.add('open');
  document.getElementById('overlay').classList.add('show');
  setTimeout(()=>document.getElementById('detailInput').focus(),350);
}
function renderDetailPanel(){
  const {dateKey,itemIdx}=detailState;
  const it=plans[dateKey][itemIdx];
  const subs=it.sub||[];
  const done=subs.filter(s=>s.done).length;
  const allDone=subs.length>0&&done===subs.length;
  const ratio=subs.length?done/subs.length:0;
  const displayColor=getItemDisplayColor(it);
  document.getElementById('detailColorBar').style.background=displayColor;
  const titleEl=document.getElementById('detailPanelTitle');
  titleEl.textContent=allDone?'‚úÖ '+it.text:it.text;
  titleEl.style.background=displayColor;
  document.getElementById('detailPanelDate').textContent='üìÖ '+dateKey;
  const wrap=document.getElementById('detailProgressWrap');
  const lbl=document.getElementById('detailProgressLabel');
  const fill=document.getElementById('detailProgressFill');
  if(subs.length){
    wrap.style.display='block';
    lbl.textContent=allDone?`üéâ Î™®Îëê ÏôÑÎ£å! (${subs.length}/${subs.length})`:`ÏôÑÎ£å ${done} / ${subs.length}  (${Math.round(ratio*100)}%)`;
    fill.style.background=displayColor;
    fill.style.width=Math.round(ratio*100)+'%';
  } else {
    wrap.style.display='none';
  }
  const list=document.getElementById('detailSubList'); list.innerHTML='';
  if(!subs.length){
    const empty=document.createElement('div'); empty.className='detail-empty';
    empty.textContent='ÏïÑÎûò ÏûÖÎ†•Ï∞ΩÏóêÏÑú ÏÑ∏Î∂ÄÏùºÏ†ïÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî';
    list.appendChild(empty);
  } else {
    subs.forEach((sub,si)=>{
      const row=document.createElement('div'); row.className='sub-item';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=sub.done;
      cb.onchange=()=>toggleSub(si);
      const txt=document.createElement('span'); txt.className='sub-text'+(sub.done?' done':''); txt.textContent=sub.text;
      const editBtn=document.createElement('button'); editBtn.className='sub-edit-btn'; editBtn.textContent='‚úèÔ∏è';
      editBtn.onclick=()=>startEditSub(si,row,txt,editBtn);
      const del=document.createElement('button'); del.className='sub-del-btn'; del.textContent='‚úï';
      del.onclick=()=>deleteSub(si);
      row.appendChild(cb); row.appendChild(txt); row.appendChild(editBtn); row.appendChild(del); list.appendChild(row);
    });
  }
}
function addSub(){
  const txt=document.getElementById('detailInput').value.trim(); if(!txt)return;
  const {dateKey,itemIdx}=detailState;
  const it=plans[dateKey][itemIdx];
  if(!it.sub) it.sub=[];
  it.sub.push({text:txt,done:false});
  document.getElementById('detailInput').value='';
  save(); renderDetailPanel();
}
function toggleSub(si){
  const {dateKey,itemIdx}=detailState;
  const it=plans[dateKey][itemIdx];
  it.sub[si].done=!it.sub[si].done;
  save(); renderDetailPanel();
}
function deleteSub(si){
  const {dateKey,itemIdx}=detailState;
  const it=plans[dateKey][itemIdx];
  it.sub.splice(si,1);
  save(); renderDetailPanel();
}
function startEditSub(si,row,txtEl,editBtn){
  const {dateKey,itemIdx}=detailState;
  const sub=plans[dateKey][itemIdx].sub[si];
  const inp=document.createElement('input'); inp.type='text'; inp.className='sub-edit-input'; inp.value=sub.text;
  txtEl.replaceWith(inp);
  editBtn.textContent='‚úì'; editBtn.style.color='#4f86f7';
  editBtn.onclick=()=>saveSub(si,inp);
  inp.onkeydown=e=>{if(e.key==='Enter')saveSub(si,inp); if(e.key==='Escape')renderDetailPanel();};
  inp.focus(); inp.select();
}
function saveSub(si,inp){
  const val=inp.value.trim(); if(!val)return;
  const {dateKey,itemIdx}=detailState;
  plans[dateKey][itemIdx].sub[si].text=val;
  save(); renderDetailPanel();
}
function closeDetail(){
  document.getElementById('detailPanel').classList.remove('open');
  if(document.getElementById('modal').classList.contains('show'))
    document.getElementById('overlay').classList.add('show');
  else
    document.getElementById('overlay').classList.remove('show');
}
function deleteItem(key,idx){
  plans[key].splice(idx,1);
  if(!plans[key].length) delete plans[key];
  save(); renderAll();
}
function exportCSV(){
  const dim=new Date(year,month+1,0).getDate();
  const rows=[['"ÎÇ†Ïßú"','"ÏöîÏùº"','"ÏùºÏ†ï"']];
  for(let d=1;d<=dim;d++){
    const key=dateKey(year,month,d);
    const dow=DAYS_KR[new Date(year,month,d).getDay()];
    const items=plans[key]||[];
    if(!items.length) rows.push([`"${key}"`,`"${dow}"`, '""']);
    else items.forEach(it=>rows.push([`"${key}"`,`"${dow}"`,`"${it.text.replace(/"/g,'""')}"`]));
  }
  const blob=new Blob(['\uFEFF'+rows.map(r=>r.join(',')).join('\n')],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download=`${year}ÎÖÑ_${month+1}Ïõî_Í≥ÑÌöç.csv`; a.click();
}

year=today.getFullYear(); month=today.getMonth();
document.getElementById('btnPrev').onclick   =()=>{if(month===0){year--;month=11;}else month--;renderAll();};
document.getElementById('btnNext').onclick   =()=>{if(month===11){year++;month=0;}else month++;renderAll();};
document.getElementById('btnToday').onclick  =()=>{year=today.getFullYear();month=today.getMonth();renderAll();};
document.getElementById('btnCsv').onclick    =exportCSV;
document.getElementById('btnWPrev').onclick  =()=>{weekBase.setDate(weekBase.getDate()-7);renderWeek();};
document.getElementById('btnWNext').onclick  =()=>{weekBase.setDate(weekBase.getDate()+7);renderWeek();};
document.getElementById('btnWToday').onclick =()=>{weekBase=new Date(today);renderWeek();};
document.getElementById('btnSave').onclick   =saveItem;
document.getElementById('btnCancel').onclick =closeModal;
document.getElementById('overlay').onclick   =()=>{
  if(document.getElementById('modal').classList.contains('show')) closeModal();
  else closeDetail();
};
document.getElementById('modalInput').onkeydown=e=>{if(e.key==='Enter')saveItem();};
document.getElementById('btnDetailAdd').onclick  =addSub;
document.getElementById('btnDetailClose').onclick=closeDetail;
document.getElementById('btnDetailEdit').onclick =()=>{
  const {dateKey,itemIdx}=detailState;
  closeDetail();
  openModal(dateKey, itemIdx);
};
document.getElementById('detailInput').onkeydown=e=>{if(e.key==='Enter')addSub();};

// ‚îÄ‚îÄ ÎìúÎûòÍ∑∏ Ìï∏Îì§ ÏïÑÎûòÎ°ú Ïä§ÏôÄÏù¥ÌîÑ ‚Üí Ìå®ÎÑê Îã´Í∏∞ ‚îÄ‚îÄ
(function(){
  const handle=document.getElementById('detailDragHandle');
  let sy=0;
  handle.addEventListener('touchstart',e=>{sy=e.touches[0].clientY;},{passive:true});
  handle.addEventListener('touchend',e=>{if(e.changedTouches[0].clientY-sy>60)closeDetail();},{passive:true});
})();
</script>
</body>
</html>
