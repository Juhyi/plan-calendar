<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì›”ê°„ ê³„íš ìº˜ë¦°ë”</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif; background: #f0f4f8; min-height: 100vh; padding: 16px; transition: padding-right .28s cubic-bezier(.4,0,.2,1); }
  body.panel-open { padding-right: 356px; }
  h2 { font-size: 22px; font-weight: 700; color: #1a2a4a; }
  #syncStatus { display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:4px 10px; border-radius:20px; font-weight:600; }
  #syncStatus.connected    { background:#e8f8ee; color:#27ae60; }
  #syncStatus.disconnected { background:#fdecea; color:#e74c3c; }
  #syncStatus.syncing      { background:#fff3e0; color:#f5a623; }
  .dot { width:8px; height:8px; border-radius:50%; background:currentColor; }
  .header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; flex-wrap:wrap; gap:8px; }
  .header-left { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  button { cursor:pointer; border-radius:6px; font-family:inherit; font-size:13px; }
  .btn       { border:1px solid #ddd; background:#fff; padding:4px 10px; }
  .btn-today { border:none; background:#4f86f7; color:#fff; padding:4px 12px; }
  .btn-csv   { border:none; background:#52c97a; color:#fff; padding:6px 16px; }
  .calendar { background:#fff; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.1); overflow:hidden; }
  .day-headers { display:grid; grid-template-columns:repeat(7,1fr); }
  .day-header { padding:10px 0; text-align:center; font-weight:700; font-size:13px; border-bottom:2px solid #e0e6ef; }
  .day-header.sun { background:#fff1f1; color:#e74c3c; }
  .day-header.sat { background:#f0f4ff; color:#4f86f7; }
  .day-header.week{ background:#f8f9fa; color:#555; }
  .week-row { display:grid; grid-template-columns:repeat(7,1fr); border-bottom:1px solid #e0e6ef; }
  .week-row:last-child { border-bottom:none; }
  .cell { min-height:90px; padding:6px; border-left:1px solid #e0e6ef; }
  .cell:first-child { border-left:none; }
  .cell.empty { background:#fafafa; }
  .cell.today { background:#fffbe6; } 
  .cell-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
  .date-num { display:inline-flex; align-items:center; justify-content:center; width:24px; height:24px; border-radius:50%; font-size:12px; font-weight:600; color:#333; }
  .date-num.today-num { background:#4f86f7; color:#fff; }
  .date-num.sun-num { color:#e74c3c; }
  .date-num.sat-num { color:#4f86f7; }
  .add-btn { border:none; background:none; font-size:16px; color:#bbb; padding:0; }
  .add-btn:hover { color:#4f86f7; }
  .items { display:flex; flex-direction:column; gap:2px; }
  .item { border-radius:4px; padding:2px 18px 2px 5px; font-size:11px; color:#fff; position:relative; cursor:pointer; word-break:break-word; line-height:1.4; }
  .item span { display:block; }
  .item .del { position:absolute; top:3px; right:4px; font-size:10px; opacity:.8; background:rgba(0,0,0,0.2); border-radius:3px; padding:0 2px; }
  .weekly-section { margin-top:24px; }
  .weekly-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap; gap:8px; }
  .weekly-header h3 { font-size:18px; font-weight:700; color:#1a2a4a; }
  .weekly-nav { display:flex; align-items:center; gap:8px; }
  .week-label { font-size:14px; color:#555; font-weight:600; min-width:200px; text-align:center; }
  .weekly-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:8px; }
  .wday-col { background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.08); overflow:hidden; min-height:320px; display:flex; flex-direction:column; }
  .wday-col.w-today { box-shadow:0 0 0 2px #4f86f7, 0 2px 8px rgba(0,0,0,.08); }
  .wday-col-header { padding:10px 6px 8px; text-align:center; border-bottom:2px solid #e0e6ef; }
  .wday-name { font-size:13px; font-weight:700; }
  .wday-name.sun { color:#e74c3c; }
  .wday-name.sat { color:#4f86f7; }
  .wday-date { font-size:22px; font-weight:800; margin-top:2px; color:#1a2a4a; }
  .wday-date.today-big { background:#4f86f7; color:#fff; border-radius:50%; width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center; font-size:20px; margin-top:4px; }
  .wday-date.sun { color:#e74c3c; }
  .wday-date.sat { color:#4f86f7; }
  .wday-items { flex:1; padding:8px 6px; display:flex; flex-direction:column; gap:4px; }
  .wday-item { border-radius:6px; padding:5px 22px 5px 8px; font-size:12px; color:#fff; cursor:pointer; line-height:1.4; position:relative; word-break:break-word; }
  .wday-item span { display:block; }
  .wday-item .del { position:absolute; top:5px; right:5px; font-size:11px; opacity:.8; background:rgba(0,0,0,0.2); border-radius:3px; padding:0 3px; }
  .wday-add { margin:0 6px 8px; border:1.5px dashed #ccc; background:none; color:#aaa; border-radius:6px; padding:5px 0; font-size:12px; width:calc(100% - 12px); }
  .wday-add:hover { border-color:#4f86f7; color:#4f86f7; }
  .overlay { display:none; position:fixed; inset:0; z-index:999; }
  .overlay.show { display:block; background:rgba(0,0,0,0.35); }
  .modal { position:fixed; background:#fff; border-radius:10px; box-shadow:0 4px 20px rgba(0,0,0,.18); padding:14px; width:240px; z-index:1000; }
  .modal-title { font-size:12px; color:#888; margin-bottom:6px; }
  .modal input { width:100%; padding:6px 8px; border-radius:6px; border:1px solid #ddd; font-size:13px; font-family:inherit; margin-bottom:8px; outline:none; }
  .modal input:focus { border-color:#4f86f7; }
  .color-row { display:flex; gap:6px; margin-bottom:10px; }
  .color-dot { width:20px; height:20px; border-radius:50%; cursor:pointer; border:2px solid transparent; }
  .color-dot.selected { border:3px solid #333; }
  .modal-btns { display:flex; gap:6px; }
  .btn-save   { flex:1; background:#4f86f7; color:#fff; border:none; padding:6px 0; font-family:inherit; border-radius:6px; }
  .btn-cancel { flex:1; background:#eee; border:none; padding:6px 0; font-family:inherit; border-radius:6px; }
  /* â”€â”€ ì„¸ë¶€ì¼ì • ì‚¬ì´ë“œ íŒ¨ë„ â”€â”€ */
  .detail-panel { position:fixed; top:0; right:-380px; width:340px; height:100vh; background:#fff; box-shadow:-4px 0 24px rgba(0,0,0,.15); z-index:1000; transition:right .28s cubic-bezier(.4,0,.2,1); display:flex; flex-direction:column; overflow:hidden; }
  .detail-panel.open { right:0; }
  .detail-color-bar { height:8px; flex-shrink:0; transition:background .4s; }
  .detail-panel-header { padding:14px 16px 14px; border-bottom:1px solid #e0e6ef; flex-shrink:0; }
  .detail-panel-top { display:flex; justify-content:space-between; align-items:flex-start; gap:8px; margin-bottom:8px; }
  .detail-panel-title { display:inline-block; padding:5px 14px; border-radius:20px; font-size:14px; font-weight:700; color:#fff; word-break:break-word; line-height:1.5; max-width:100%; transition:background .4s; }
  .detail-panel-date { font-size:12px; color:#888; margin-top:2px; }
  .detail-panel-btns { display:flex; gap:6px; flex-shrink:0; }
  .detail-panel-btn { border:none; cursor:pointer; padding:5px 10px; border-radius:6px; font-size:12px; font-family:inherit; }
  .detail-panel-btn.edit { background:#f0f4ff; color:#4f86f7; }
  .detail-panel-btn.edit:hover { background:#dce8ff; }
  .detail-panel-btn.close { background:#f0f0f0; color:#555; }
  .detail-panel-btn.close:hover { background:#e0e0e0; }
  .detail-progress-wrap { padding:12px 16px 0; flex-shrink:0; }
  .detail-progress-label { font-size:12px; color:#666; margin-bottom:6px; font-weight:600; }
  .detail-progress-track { height:7px; background:#e0e6ef; border-radius:4px; overflow:hidden; }
  .detail-progress-fill { height:100%; background:#52c97a; border-radius:4px; transition:width .3s; }
  .detail-sub-list { flex:1; overflow-y:auto; padding:12px 16px; display:flex; flex-direction:column; gap:8px; }
  .sub-item { display:flex; align-items:flex-start; gap:10px; padding:10px 12px; border-radius:8px; background:#f8f9fa; border:1px solid #e8ecf0; }
  .sub-item input[type=checkbox] { cursor:pointer; width:17px; height:17px; flex-shrink:0; accent-color:#4f86f7; margin-top:2px; }
  .sub-text { flex:1; font-size:13px; color:#333; word-break:break-word; line-height:1.5; }
  .sub-text.done { text-decoration:line-through; color:#bbb; }
  .sub-del-btn { border:none; background:none; cursor:pointer; font-size:13px; color:#ddd; padding:0 3px; flex-shrink:0; }
  .sub-del-btn:hover { color:#e74c3c; }
  .sub-edit-btn { border:none; background:none; cursor:pointer; font-size:12px; color:#ccc; padding:0 3px; flex-shrink:0; }
  .sub-edit-btn:hover { color:#4f86f7; }
  .sub-edit-input { flex:1; padding:3px 8px; border:1.5px solid #4f86f7; border-radius:5px; font-size:13px; font-family:inherit; outline:none; min-width:0; }
  .detail-empty { text-align:center; padding:40px 0; color:#bbb; font-size:13px; }
  .detail-add-row { padding:12px 16px; border-top:1px solid #e0e6ef; display:flex; gap:8px; flex-shrink:0; }
  .detail-add-row input { flex:1; padding:9px 12px; border-radius:8px; border:1px solid #ddd; font-size:13px; font-family:inherit; outline:none; }
  .detail-add-row input:focus { border-color:#4f86f7; }
  .detail-add-btn { border:none; background:#4f86f7; color:#fff; border-radius:8px; padding:9px 18px; font-size:13px; cursor:pointer; font-family:inherit; font-weight:600; }
  #configPanel { background:#fff3cd; border:1px solid #ffc107; border-radius:10px; padding:16px; margin-bottom:16px; }
  #configPanel h4 { color:#856404; margin-bottom:8px; font-size:14px; }
  #configPanel textarea { width:100%; height:140px; border-radius:6px; border:1px solid #ddd; padding:8px; font-size:12px; font-family:monospace; resize:vertical; }
  #btnApplyConfig { margin-top:8px; background:#f5a623; color:#fff; border:none; padding:6px 16px; border-radius:6px; font-family:inherit; cursor:pointer; }
  #configPanel p { font-size:12px; color:#856404; margin-bottom:6px; }
  #debugLog { margin-top:10px; background:#1e1e1e; color:#0f0; border-radius:6px; padding:10px; font-size:11px; font-family:monospace; max-height:150px; overflow-y:auto; display:none; white-space:pre-wrap; word-break:break-all; }
</style>
</head>
<body>

<div id="configPanel">
  <h4>ğŸ”§ Firebase ì„¤ì • ì…ë ¥ (ìµœì´ˆ 1íšŒë§Œ)</h4>
  <p>Firebase ì½˜ì†”ì—ì„œ ë³µì‚¬í•œ <strong>firebaseConfig</strong> ì „ì²´ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>
  <textarea id="configInput" placeholder="const firebaseConfig = { ... } ì „ì²´ ë¶™ì—¬ë„£ê¸°"></textarea>
  <br>
  <button id="btnApplyConfig">âœ… ì €ì¥ ë° ì—°ê²°</button>
  <div id="debugLog"></div>
</div>

<div id="mainUI" style="display:none">
  <div class="header">
    <div class="header-left">
      <button class="btn" id="btnPrev">â—€</button>
      <h2 id="title"></h2>
      <button class="btn" id="btnNext">â–¶</button>
      <button class="btn btn-today" id="btnToday">ì˜¤ëŠ˜</button>
      <span id="syncStatus" class="syncing"><span class="dot"></span> ì—°ê²° ì¤‘...</span>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-csv" id="btnCsv">ğŸ“¥ CSV</button>
      <button class="btn" id="btnResetConfig" style="font-size:11px;color:#aaa">âš™ï¸ ì„¤ì • ë³€ê²½</button>
    </div>
  </div>
  <div class="calendar">
    <div class="day-headers">
      <div class="day-header sun">ì¼</div>
      <div class="day-header week">ì›”</div>
      <div class="day-header week">í™”</div>
      <div class="day-header week">ìˆ˜</div>
      <div class="day-header week">ëª©</div>
      <div class="day-header week">ê¸ˆ</div>
      <div class="day-header sat">í† </div>
    </div>
    <div id="calBody"></div>
  </div>
  <div class="weekly-section">
    <div class="weekly-header">
      <h3>ğŸ“‹ ì£¼ê°„ ê³„íš</h3>
      <div class="weekly-nav">
        <button class="btn" id="btnWPrev">â—€</button>
        <span class="week-label" id="weekLabel"></span>
        <button class="btn" id="btnWNext">â–¶</button>
        <button class="btn btn-today" id="btnWToday">ì´ë²ˆ ì£¼</button>
      </div>
    </div>
    <div class="weekly-grid" id="weeklyGrid"></div>
  </div>
</div>

<div class="overlay" id="overlay"></div>
<div class="modal" id="modal" style="display:none">
  <div class="modal-title" id="modalTitle"></div>
  <input type="text" id="modalInput" placeholder="ì¼ì • ë‚´ìš© ì…ë ¥..." maxlength="50">
  <div class="color-row" id="colorRow"></div>
  <div class="modal-btns">
    <button class="btn-save" id="btnSave">ì¶”ê°€</button>
    <button class="btn-cancel" id="btnCancel">ì·¨ì†Œ</button>
  </div>
</div>
<div class="detail-panel" id="detailPanel">
  <div class="detail-color-bar" id="detailColorBar"></div>
  <div class="detail-panel-header">
    <div class="detail-panel-top">
      <div class="detail-panel-title" id="detailPanelTitle"></div>
      <div class="detail-panel-btns">
        <button class="detail-panel-btn edit" id="btnDetailEdit">âœï¸ ìˆ˜ì •</button>
        <button class="detail-panel-btn close" id="btnDetailClose">âœ• ë‹«ê¸°</button>
      </div>
    </div>
    <div class="detail-panel-date" id="detailPanelDate"></div>
  </div>
  <div class="detail-progress-wrap" id="detailProgressWrap">
    <div class="detail-progress-label" id="detailProgressLabel"></div>
    <div class="detail-progress-track"><div class="detail-progress-fill" id="detailProgressFill"></div></div>
  </div>
  <div class="detail-sub-list" id="detailSubList"></div>
  <div class="detail-add-row">
    <input type="text" id="detailInput" placeholder="ì„¸ë¶€ì¼ì • ì¶”ê°€..." maxlength="50">
    <button class="detail-add-btn" id="btnDetailAdd">ì¶”ê°€</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
<script>
const COLORS  = ["#0a0101","#9b59b6","#4f86f7","#f76b6b","#52c97a","#f5a623","#1abc9c","#e74c3c"];
const DAYS_KR = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
const today   = new Date();
let year, month, plans = {}, weekBase = new Date(today);
let modal = { dateKey:null, editIdx:null, colorIdx:0 };
let dbRef = null;

// â”€â”€ ë””ë²„ê·¸ ë¡œê·¸ (í™”ë©´ + ì½˜ì†” ë™ì‹œ ì¶œë ¥) â”€â”€
const dbgEl = document.getElementById('debugLog');
function dbg(label, val) {
  const msg = `${label}: ${typeof val === 'string' ? val : JSON.stringify(val, null, 2)}`;
  console.log(msg);
  dbgEl.style.display = 'block';
  dbgEl.textContent += msg + '\n';
}
function dbgErr(label, e) {
  const msg = `âŒ ${label}: ${e.message}`;
  console.error(msg, e);
  dbgEl.style.display = 'block';
  dbgEl.textContent += msg + '\n';
}

// â”€â”€ Firebase ì´ˆê¸°í™” â”€â”€
function initFirebase(config) {
  try {
    dbg('[initFirebase] config', config);
    if (!firebase.apps.length) {
      firebase.initializeApp(config);
    }
    dbg('[initFirebase] ì•± ì´ˆê¸°í™” ì™„ë£Œ', firebase.app().name);
    const db = firebase.database();
    dbRef = db.ref('calendar/plans');
    dbg('[initFirebase] dbRef ìƒì„± ì™„ë£Œ', 'calendar/plans');

    db.ref('.info/connected').on('value', snap => {
      const el = document.getElementById('syncStatus');
      if (snap.val()) {
        el.className = 'connected'; el.innerHTML = '<span class="dot"></span> ì‹¤ì‹œê°„ ì—°ê²°ë¨';
        dbg('[ì—°ê²°ìƒíƒœ]', 'ì—°ê²°ë¨');
      } else {
        el.className = 'disconnected'; el.innerHTML = '<span class="dot"></span> ì—°ê²° ëŠê¹€';
        dbg('[ì—°ê²°ìƒíƒœ]', 'ëŠê¹€');
      }
    });

    dbRef.on('value', snap => {
      plans = snap.val() || {};
      dbg('[ë°ì´í„° ìˆ˜ì‹ ]', `${Object.keys(plans).length}ê°œ ë‚ ì§œ`);
      renderAll();
    });

    document.getElementById('configPanel').style.display = 'none';
    document.getElementById('mainUI').style.display = 'block';
  } catch(e) {
    dbgErr('[initFirebase ì˜¤ë¥˜]', e);
    alert('Firebase ì´ˆê¸°í™” ì˜¤ë¥˜: ' + e.message);
  }
}

// â”€â”€ ì„¤ì •ê°’ íŒŒì‹± â”€â”€
document.getElementById('btnApplyConfig').onclick = () => {
  dbgEl.textContent = '';
  dbgEl.style.display = 'block';
  const raw = document.getElementById('configInput').value;
  dbg('[1] raw ê¸¸ì´', raw.length);

  const match = raw.match(/\{[\s\S]*\}/);
  if (!match) { alert('{ } ë¸”ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
  dbg('[2] { } ì¶”ì¶œ ì„±ê³µ, ê¸¸ì´', match[0].length);

  try {
    let s = match[0];
    s = s.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '');
    dbg('[3] ì œì–´ë¬¸ì ì œê±° í›„ ê¸¸ì´', s.length);
    s = s.replace(/\u200B|\u200C|\u200D|\uFEFF/g, '');
    dbg('[4] ìœ ë‹ˆì½”ë“œ ì œê±° í›„ ê¸¸ì´', s.length);
    s = s.replace(/^\s*\/\/.*$/gm, '').replace(/\/\*[\s\S]*?\*\//g, ''); // ì¤„ ì‹œì‘ // ë§Œ ì œê±° (URL ë‚´ // ë³´í˜¸)
    dbg('[5] ì£¼ì„ ì œê±° í›„ ê¸¸ì´', s.length);
    s = s.replace(/,(\s*[\}\]])/g, '$1');
    dbg('[6] trailing comma ì œê±° í›„ ê¸¸ì´', s.length);
    s = s.replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":');
    dbg('[7] í‚¤ ë”°ì˜´í‘œ ì¶”ê°€ í›„', s);

    // ë‚¨ì•„ìˆëŠ” ì œì–´ë¬¸ì ìœ„ì¹˜ ì°¾ê¸°
    for (let i = 0; i < s.length; i++) {
      const c = s.charCodeAt(i);
      if (c < 0x20 && c !== 0x09 && c !== 0x0A && c !== 0x0D) {
        dbg(`[!] ì œì–´ë¬¸ì position ${i}`, `charCode=${c} ì£¼ë³€="${s.substring(Math.max(0,i-10), i+10)}"`);
      }
    }

    const cfg = JSON.parse(s);
    dbg('[8] íŒŒì‹± ì„±ê³µ!', Object.keys(cfg));
    if (!cfg.databaseURL) { alert('databaseURLì´ ì—†ìŠµë‹ˆë‹¤!'); return; }
    localStorage.setItem('fbConfig', JSON.stringify(cfg));
    initFirebase(cfg);
  } catch(e) {
    dbgErr('[íŒŒì‹± ì˜¤ë¥˜]', e);
    alert('íŒŒì‹± ì˜¤ë¥˜: ' + e.message + '\n\ní™”ë©´ í•˜ë‹¨ ë…¸ë€ ë°•ìŠ¤ì˜ ë¹¨ê°„ ë¡œê·¸ë¥¼ ìº¡ì²˜í•´ì„œ ì•Œë ¤ì£¼ì„¸ìš”!');
  }
};

document.getElementById('btnResetConfig').onclick = () => {
  document.getElementById('configPanel').style.display = 'block';
  document.getElementById('mainUI').style.display = 'none';
};

// ì €ì¥ëœ ì„¤ì • ìë™ ë¡œë“œ
const saved = localStorage.getItem('fbConfig');
if (saved) {
  try { initFirebase(JSON.parse(saved)); } catch(e) { console.error(e); }
}

// â”€â”€ DB ì €ì¥ â”€â”€
function save() {
  if (!dbRef) return;
  const st = document.getElementById('syncStatus');
  st.className='syncing'; st.innerHTML='<span class="dot"></span> ì €ì¥ ì¤‘...';
  dbRef.set(plans)
    .then(()=>{ st.className='connected'; st.innerHTML='<span class="dot"></span> ì‹¤ì‹œê°„ ì—°ê²°ë¨'; })
    .catch(e=>{ st.className='disconnected'; st.innerHTML='<span class="dot"></span> ì €ì¥ ì‹¤íŒ¨'; alert('ì €ì¥ ì‹¤íŒ¨: '+e.message); });
}

function dateKey(y,m,d){ return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
function isToday(d,m2,y2){ return y2===today.getFullYear()&&m2===today.getMonth()&&d===today.getDate(); }

/* â”€â”€ ìƒ‰ìƒ ìœ í‹¸ë¦¬í‹° â”€â”€ */
function hexToRgb(hex){ return [1,3,5].map(i=>parseInt(hex.slice(i,i+2),16)); }
function rgbToHex(r,g,b){ return '#'+[r,g,b].map(v=>Math.round(v).toString(16).padStart(2,'0')).join(''); }
function blendColor(hex1,hex2,t){
  const [r1,g1,b1]=hexToRgb(hex1), [r2,g2,b2]=hexToRgb(hex2);
  return rgbToHex(r1+(r2-r1)*t, g1+(g2-g1)*t, b1+(b2-b1)*t);
}
function getItemDisplayColor(it){
  const subs=it.sub||[]; if(!subs.length) return it.color;
  const ratio=subs.filter(s=>s.done).length/subs.length;
  return ratio===0?it.color:blendColor(it.color,'#9b59b6',ratio);
}

function renderMonth() {
  document.getElementById('title').textContent=`${year}ë…„ ${month+1}ì›”`;
  const body=document.getElementById('calBody'); body.innerHTML='';
  const firstDay=new Date(year,month,1).getDay(), dim=new Date(year,month+1,0).getDate();
  const cells=[];
  for(let i=0;i<firstDay;i++) cells.push(null);
  for(let d=1;d<=dim;d++) cells.push(d);
  while(cells.length%7!==0) cells.push(null);
  for(let w=0;w<cells.length/7;w++){
    const row=document.createElement('div'); row.className='week-row';
    for(let di=0;di<7;di++){
      const d=cells[w*7+di];
      const cell=document.createElement('div');
      cell.className='cell'+(!d?' empty':isToday(d,month,year)?' today':'');
      if(d){
        const key=dateKey(year,month,d);
        const hdr=document.createElement('div'); hdr.className='cell-header';
        const num=document.createElement('span');
        num.className='date-num'+(isToday(d,month,year)?' today-num':di===0?' sun-num':di===6?' sat-num':'');
        num.textContent=d;
        const ab=document.createElement('button'); ab.className='add-btn'; ab.textContent='+';
        ab.onclick=e=>{e.stopPropagation();openModal(key,null,e.currentTarget);};
        hdr.appendChild(num); hdr.appendChild(ab); cell.appendChild(hdr);
        const idiv=document.createElement('div'); idiv.className='items';
        (plans[key]||[]).forEach((it,idx)=>{
          const item=document.createElement('div'); item.className='item'; item.style.background=getItemDisplayColor(it);
          const txt=document.createElement('span'); txt.textContent=it.text;
          const del=document.createElement('span'); del.className='del'; del.textContent='âœ•';
          del.onclick=e=>{e.stopPropagation();deleteItem(key,idx);};
          item.onclick=e=>{e.stopPropagation();openDetail(key,idx,e.currentTarget);};
          item.appendChild(txt); item.appendChild(del); idiv.appendChild(item);
        });
        cell.appendChild(idiv);
      }
      row.appendChild(cell);
    }
    body.appendChild(row);
  } 
}

function getWeekStart(base){ const d=new Date(base); d.setDate(d.getDate()-d.getDay()); return d; }
function renderWeek(){
  const ws=getWeekStart(weekBase), we=new Date(ws); we.setDate(we.getDate()+6);
  const fmt=d=>`${d.getMonth()+1}/${d.getDate()}`;
  document.getElementById('weekLabel').textContent=`${ws.getFullYear()}ë…„ ${fmt(ws)}(ì¼) ~ ${fmt(we)}(í† )`;
  const grid=document.getElementById('weeklyGrid'); grid.innerHTML='';
  for(let di=0;di<7;di++){
    const cur=new Date(ws); cur.setDate(ws.getDate()+di);
    const y2=cur.getFullYear(),m2=cur.getMonth(),d2=cur.getDate();
    const key=dateKey(y2,m2,d2); const isTd=isToday(d2,m2,y2);
    const col=document.createElement('div'); col.className='wday-col'+(isTd?' w-today':'');
    const hdr=document.createElement('div'); hdr.className='wday-col-header';
    const nm=document.createElement('div'); nm.className='wday-name'+(di===0?' sun':di===6?' sat':''); nm.textContent=DAYS_KR[di];
    const dt=document.createElement('div');
    dt.className=isTd?'wday-date today-big':'wday-date'+(di===0?' sun':di===6?' sat':'');
    dt.textContent=d2;
    hdr.appendChild(nm); hdr.appendChild(dt); col.appendChild(hdr);
    const idiv=document.createElement('div'); idiv.className='wday-items';
    (plans[key]||[]).forEach((it,idx)=>{
      const item=document.createElement('div'); item.className='wday-item'; item.style.background=getItemDisplayColor(it);
      const txt=document.createElement('span'); txt.textContent=it.text;
      const del=document.createElement('span'); del.className='del'; del.textContent='âœ•';
      del.onclick=e=>{e.stopPropagation();deleteItem(key,idx);}; 
      item.onclick=e=>{e.stopPropagation();openDetail(key,idx,e.currentTarget);};
      item.appendChild(txt); item.appendChild(del); idiv.appendChild(item);
    });
    col.appendChild(idiv);
    const ab=document.createElement('button'); ab.className='wday-add'; ab.textContent='+ ì¼ì • ì¶”ê°€';
    ab.onclick=e=>{e.stopPropagation();openModal(key,null,e.currentTarget);};
    col.appendChild(ab); grid.appendChild(col);
  }
}
function renderAll(){ renderMonth(); renderWeek(); }

function openModal(key,editIdx,anchor){
  modal.dateKey=key; modal.editIdx=editIdx; modal.colorIdx=0;
  const inp=document.getElementById('modalInput');
  if(editIdx!==null){
    const it=plans[key][editIdx]; inp.value=it.text;
    modal.colorIdx=COLORS.indexOf(it.color)>=0?COLORS.indexOf(it.color):0;
    document.getElementById('modalTitle').textContent=`âœï¸ ìˆ˜ì • â€” ${key}`;
    document.getElementById('btnSave').textContent='ìˆ˜ì •';
  } else {
    inp.value='';
    document.getElementById('modalTitle').textContent=`ğŸ“ ì¶”ê°€ â€” ${key}`;
    document.getElementById('btnSave').textContent='ì¶”ê°€';
  }
  renderColorRow();
  const rect=anchor.getBoundingClientRect();
  let left=rect.left+window.scrollX, top=rect.bottom+window.scrollY+4;
  if(left+240>window.innerWidth) left=window.innerWidth-248;
  if(top+160>window.innerHeight+window.scrollY) top=rect.top+window.scrollY-164;
  const m=document.getElementById('modal');
  m.style.left=left+'px'; m.style.top=top+'px'; m.style.display='block';
  document.getElementById('overlay').classList.add('show');
  setTimeout(()=>inp.focus(),30);
}
function renderColorRow(){
  const row=document.getElementById('colorRow'); row.innerHTML='';
  COLORS.forEach((c,i)=>{ 
    const dot=document.createElement('div');
    dot.className='color-dot'+(i===modal.colorIdx?' selected':'');
    dot.style.background=c;
    dot.onclick=()=>{modal.colorIdx=i;renderColorRow();};
    row.appendChild(dot);
  });
}
function closeModal(){
  document.getElementById('modal').style.display='none';
  document.getElementById('overlay').classList.remove('show');
}
function saveItem(){
  const txt=document.getElementById('modalInput').value.trim(); if(!txt)return;
  const key=modal.dateKey;
  if(!plans[key]) plans[key]=[];
  if(modal.editIdx!==null){
    const existingSub=plans[key][modal.editIdx].sub||[];
    plans[key][modal.editIdx]={text:txt,color:COLORS[modal.colorIdx],sub:existingSub};
  } else {
    plans[key].push({text:txt,color:COLORS[modal.colorIdx],sub:[]});
  }
  save(); closeModal(); renderAll();
}

/* â”€â”€ ì„¸ë¶€ì¼ì • ì‚¬ì´ë“œ íŒ¨ë„ â”€â”€ */
let detailState={dateKey:null,itemIdx:null,anchor:null};
function openDetail(key,idx,anchor){
  detailState={dateKey:key,itemIdx:idx,anchor:anchor};
  renderDetailPanel();
  document.getElementById('detailPanel').classList.add('open');
  document.body.classList.add('panel-open');
  setTimeout(()=>document.getElementById('detailInput').focus(),300);
}
function renderDetailPanel(){
  const {dateKey,itemIdx}=detailState;
  const it=plans[dateKey][itemIdx];
  const subs=it.sub||[];
  const done=subs.filter(s=>s.done).length;
  const allDone=subs.length>0&&done===subs.length;
  const ratio=subs.length?done/subs.length:0;
  const displayColor=getItemDisplayColor(it);
  document.getElementById('detailColorBar').style.background=displayColor;
  const titleEl=document.getElementById('detailPanelTitle');
  titleEl.textContent=allDone?'âœ… '+it.text:it.text;
  titleEl.style.background=displayColor;
  document.getElementById('detailPanelDate').textContent='ğŸ“… '+dateKey;
  const wrap=document.getElementById('detailProgressWrap');
  const lbl=document.getElementById('detailProgressLabel');
  const fill=document.getElementById('detailProgressFill');
  if(subs.length){
    wrap.style.display='block';
    lbl.textContent=allDone?`ğŸ‰ ëª¨ë‘ ì™„ë£Œ! (${subs.length}/${subs.length})`:`ì™„ë£Œ ${done} / ${subs.length}  (${Math.round(ratio*100)}%)`;
    fill.style.background=displayColor;
    fill.style.width=Math.round(ratio*100)+'%';
  } else {
    wrap.style.display='none';
  }
  const list=document.getElementById('detailSubList'); list.innerHTML='';
  if(!subs.length){
    const empty=document.createElement('div'); empty.className='detail-empty';
    empty.textContent='ì•„ë˜ ì…ë ¥ì°½ì—ì„œ ì„¸ë¶€ì¼ì •ì„ ì¶”ê°€í•˜ì„¸ìš”';
    list.appendChild(empty);
  } else {
    subs.forEach((sub,si)=>{
      const row=document.createElement('div'); row.className='sub-item';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=sub.done;
      cb.onchange=()=>toggleSub(si);
      const txt=document.createElement('span'); txt.className='sub-text'+(sub.done?' done':''); txt.textContent=sub.text;
      const editBtn=document.createElement('button'); editBtn.className='sub-edit-btn'; editBtn.textContent='âœï¸';
      editBtn.onclick=()=>startEditSub(si,row,txt,editBtn);
      const del=document.createElement('button'); del.className='sub-del-btn'; del.textContent='âœ•';
      del.onclick=()=>deleteSub(si);
      row.appendChild(cb); row.appendChild(txt); row.appendChild(editBtn); row.appendChild(del); list.appendChild(row);
    });
  }
}
function addSub(){
  const txt=document.getElementById('detailInput').value.trim(); if(!txt)return;
  const {dateKey,itemIdx}=detailState;
  const it=plans[dateKey][itemIdx];
  if(!it.sub) it.sub=[];
  it.sub.push({text:txt,done:false});
  document.getElementById('detailInput').value='';
  save(); renderDetailPanel();
}
function toggleSub(si){
  const {dateKey,itemIdx}=detailState;
  const it=plans[dateKey][itemIdx];
  it.sub[si].done=!it.sub[si].done;
  save(); renderDetailPanel();
}
function deleteSub(si){
  const {dateKey,itemIdx}=detailState;
  const it=plans[dateKey][itemIdx];
  it.sub.splice(si,1);
  save(); renderDetailPanel();
}
function startEditSub(si,row,txtEl,editBtn){
  const {dateKey,itemIdx}=detailState;
  const sub=plans[dateKey][itemIdx].sub[si];
  const inp=document.createElement('input'); inp.type='text'; inp.className='sub-edit-input'; inp.value=sub.text;
  txtEl.replaceWith(inp);
  editBtn.textContent='âœ“'; editBtn.style.color='#4f86f7';
  editBtn.onclick=()=>saveSub(si,inp);
  inp.onkeydown=e=>{if(e.key==='Enter')saveSub(si,inp); if(e.key==='Escape')renderDetailPanel();};
  inp.focus(); inp.select();
}
function saveSub(si,inp){
  const val=inp.value.trim(); if(!val)return;
  const {dateKey,itemIdx}=detailState;
  plans[dateKey][itemIdx].sub[si].text=val;
  save(); renderDetailPanel();
}
function closeDetail(){
  document.getElementById('detailPanel').classList.remove('open');
  document.body.classList.remove('panel-open');
}
function deleteItem(key,idx){
  plans[key].splice(idx,1);
  if(!plans[key].length) delete plans[key];
  save(); renderAll();
}
function exportCSV(){
  const dim=new Date(year,month+1,0).getDate();
  const rows=[['"ë‚ ì§œ"','"ìš”ì¼"','"ì¼ì •"']];
  for(let d=1;d<=dim;d++){
    const key=dateKey(year,month,d);
    const dow=DAYS_KR[new Date(year,month,d).getDay()];
    const items=plans[key]||[];
    if(!items.length) rows.push([`"${key}"`,`"${dow}"`, '""']);
    else items.forEach(it=>rows.push([`"${key}"`,`"${dow}"`,`"${it.text.replace(/"/g,'""')}"`]));
  }
  const blob=new Blob(['\uFEFF'+rows.map(r=>r.join(',')).join('\n')],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download=`${year}ë…„_${month+1}ì›”_ê³„íš.csv`; a.click();
}

year=today.getFullYear(); month=today.getMonth();
document.getElementById('btnPrev').onclick   =()=>{if(month===0){year--;month=11;}else month--;renderAll();};
document.getElementById('btnNext').onclick   =()=>{if(month===11){year++;month=0;}else month++;renderAll();};
document.getElementById('btnToday').onclick  =()=>{year=today.getFullYear();month=today.getMonth();renderAll();};
document.getElementById('btnCsv').onclick    =exportCSV;
document.getElementById('btnWPrev').onclick  =()=>{weekBase.setDate(weekBase.getDate()-7);renderWeek();};
document.getElementById('btnWNext').onclick  =()=>{weekBase.setDate(weekBase.getDate()+7);renderWeek();};
document.getElementById('btnWToday').onclick =()=>{weekBase=new Date(today);renderWeek();};
document.getElementById('btnSave').onclick   =saveItem;
document.getElementById('btnCancel').onclick =closeModal;
document.getElementById('overlay').onclick   =closeModal;
document.getElementById('modalInput').onkeydown=e=>{if(e.key==='Enter')saveItem();};
document.getElementById('btnDetailAdd').onclick =addSub;
document.getElementById('btnDetailClose').onclick=closeDetail;
document.getElementById('btnDetailEdit').onclick =()=>{closeDetail();openModal(detailState.dateKey,detailState.itemIdx,detailState.anchor);};
document.getElementById('detailInput').onkeydown =e=>{if(e.key==='Enter')addSub();};
</script>
</body>
</html>